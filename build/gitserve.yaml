apiVersion: argoproj.io/v1alpha1
kind: WorkflowEventBinding
metadata:
  name: event-consumer
  namespace: build
spec:
  event:
    selector: payload.repo == "gitserve" && payload.commit != "" && payload.ref == "refs/heads/master" && discriminator == "git"
  submit:
    workflowTemplateRef:
      name: gitserve-build
    arguments:
      parameters:
      - name: commit
        valueFrom:
          event: payload.commit
      - name: ref
        valueFrom:
          event: payload.ref
---
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: gitserve-build
  namespace: build
  labels:
    build: gitserve
spec:
  workflowMetadata:
    labels:
      build: gitserve
  entrypoint: build
  arguments:
    parameters:
      - name: commit
      - name: ref
        value: "refs/heads/master"
  templates:
    - name: build
      inputs:
        parameters:
          - name: commit
            value: '{{workflow.parameters.commit}}'
          - name: ref
            value: '{{workflow.parameters.ref}}'
      outputs:
        parameters:
          - name: image
            valueFrom:
              path: /artifacts/image
      container:
        name: main
        image: gcr.io/kaniko-project/executor:latest
        args:
          - "--dockerfile=Dockerfile"
          - "--context=git://git.andyleap.dev/gitserve#{{inputs.parameters.ref}}#{{inputs.parameters.commit}}"
          - "--destination=andyleap/gitserve:{{inputs.parameters.commit}}"
          - "--image-name-with-digest-file=/artifacts/image"
        volumeMounts:
          - name: docker
            mountPath: /kaniko/.docker/
          - name: artifacts
            mountPath: /artifacts/
      volumes:
        - name: docker
          secret:
            secretName: docker
        - name: artifacts
          emptyDir: { }
  ttlStrategy:
    secondsAfterCompletion: 3600
  podGC:
    strategy: OnPodCompletion
