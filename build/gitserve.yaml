apiVersion: argoproj.io/v1alpha1
kind: WorkflowEventBinding
metadata:
  name: gitserve-event-consumer
  namespace: build
spec:
  event:
    selector: payload.repo == "gitserve" && payload.commit != "" && payload.ref == "refs/heads/master" && discriminator == "gitserve"
  submit:
    workflowTemplateRef:
      name: gitserve-build
    arguments:
      parameters:
      - name: commit
        valueFrom:
          event: payload.commit
      - name: ref
        valueFrom:
          event: payload.ref
---
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: gitserve-build
  namespace: build
  labels:
    build: gitserve
spec:
  workflowMetadata:
    labels:
      build: gitserve
  entrypoint: build-and-deploy
  arguments:
    parameters:
      - name: commit
      - name: ref
        value: "refs/heads/master"
  templates:
    - name: build-and-deploy
      dag: 
        tasks:
        - name: build
          template: build
          arguments:
            parameters:
            - name: commit
              value: '{{workflow.parameters.commit}}'
            - name: ref
              value: '{{workflow.parameters.ref}}'
        - name: deploy
          template: deploy
          depends: build
          arguments:
            parameters:
            - name: digest
              value: '{{tasks.build.outputs.parameters.image}}'
            - name: repo
              value: https://git.andyleap.dev/cluster
            - name: branch
              value: master
            - name: file
              value: gitserve/gitserve.image
            - name: message
              value: updating+gitserve
    - name: build
      inputs:
        parameters:
          - name: commit
            value: ''
          - name: ref
            value: ''
      outputs:
        parameters:
          - name: image
            valueFrom:
              path: /artifacts/image
      container:
        name: main
        image: gcr.io/kaniko-project/executor:latest
        args:
          - "--dockerfile=Dockerfile"
          - "--context=git://git.andyleap.dev/gitserve#{{inputs.parameters.ref}}#{{inputs.parameters.commit}}"
          - "--destination=andyleap/gitserve:{{inputs.parameters.commit}}"
          - "--image-name-with-digest-file=/artifacts/image"
        volumeMounts:
          - name: docker
            mountPath: /kaniko/.docker/
          - name: artifacts
            mountPath: /artifacts/
      volumes:
        - name: docker
          secret:
            secretName: docker
        - name: artifacts
          emptyDir: { }
    - name: deploy
      inputs:
        parameters:
        - name: digest
        - name: repo
        - name: file
        - name: branch
        - name: message
          value: update
      container:
        name: main
        image: alpine
        command: ["wget"]
        args:
        - "-O=-"
        - "http://gitupdate.gitserve:8080/set?repo={{inputs.parameters.repo}}&file={{inputs.parameters.file}}&branch={{inputs.parameters.branch}}&message={{inputs.parameters.message}}&data={{inputs.parameters.digest}}"
  ttlStrategy:
    secondsAfterCompletion: 3600
  podGC:
    strategy: OnPodCompletion
